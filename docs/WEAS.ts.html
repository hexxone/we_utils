

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> WEAS.ts</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="CComponent.html">CComponent</a></li><li><a href="CSettings.html">CSettings</a></li><li><a href="CUESettings.html">CUESettings</a></li><li><a href="OfflinePlugin.html">OfflinePlugin</a></li><li><a href="ReloadHelper.html">ReloadHelper</a></li><li><a href="ReloadSettings.html">ReloadSettings</a></li><li><a href="WarnHelper.html">WarnHelper</a></li><li><a href="WarnSettings.html">WarnSettings</a></li><li><a href="WEAS.html">WEAS</a></li><li><a href="WEASettings.html">WEASettings</a></li><li><a href="WEICUE.html">WEICUE</a></li><li><a href="WEWWA.html">WEWWA</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getAllFiles">getAllFiles</a></li><li><a href="global.html#LogLevel">LogLevel</a></li><li><a href="global.html#LogLevel%255Bundefined%255D">LogLevel[undefined]</a></li><li><a href="global.html#offlineSchema">offlineSchema</a></li><li><a href="global.html#Smallog">Smallog</a></li><li><a href="global.html#waitReady">waitReady</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>WEAS.ts</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* @author hexxone / https://hexx.one
*
* @license
* Copyright (c) 2021 hexxone All rights reserved.
* Licensed under the GNU GENERAL PUBLIC LICENSE.
* See LICENSE file in the project root for full license information.
*/

import {CComponent} from './CComponent';
import {CSettings} from './CSettings';
import {waitReady} from './Util';
import {Smallog} from './Smallog';

import wascWorker from './wasc-worker/WascWorker';
import {WascInterface} from './wasc-worker/WascInterface';

const DAT_LEN = 128;

/**
* Audio processing settings
* @extends {CSettings}
*/
export class WEASettings extends CSettings {
	/** do audio processing? */
	public audioprocessing: boolean = true;
	// do pink-noise processing?
	public equalize: boolean = true;
	// convert to mono?
	public mono_audio: boolean = true;
	// invert low &amp; high freqs?
	public audio_direction: number = 0;
	// peak filtering
	public peak_filter: number = 1;
	// neighbour-smoothing value
	public value_smoothing: number = 2;
	// time-value smoothing ratio
	public audio_increase: number = 75;
	public audio_decrease: number = 35;
	// multipliers
	public treble_multiplier: number = 0.5;
	public mids_multiplier: number = 0.75;
	public bass_multiplier: number = 1.8;
	// ignore value leveling for "silent" data
	public minimum_volume: number = 0.005;
	// use low latency audio?
	public low_latency: boolean = false;
}

const SettIDs = {
	equalize: 0,
	mono_audio: 1,
	audio_direction: 2,
	peak_filter: 3,
	value_smoothing: 4,
	audio_increase: 5,
	audio_decrease: 6,
	treble_multiplier: 7,
	mids_multiplier: 8,
	bass_multiplier: 9,
	minimum_volume: 10,
};

const PropIDs = {
	bass: 0,
	mids: 1,
	highs: 2,
	sum: 3,
	min: 4,
	max: 5,
	average: 6,
	range: 7,
	silent: 8,
	intensity: 9,
};

/**
* WEAS
* &lt;br/>
* Wallpaper Engine Audio Supplier makes working with audio easier.
* &lt;br/>
* It will automatically start to receive and process the audio data
* which can then be accessed on the global object.
* &lt;br/>
* DEPENDS ON:
* &lt;br/>
* - Wallpaper Engine Web Wallpaper environment
* &lt;br/>
* - audio-processing supported web wallpaper
* @extends {CComponent}
*/
export class WEAS extends CComponent {
	// last processed audio object
	public lastAudio = null;

	// settings object
	public settings: WEASettings = new WEASettings();

	// create transfer buffer
	private inBuff = new Float64Array(DAT_LEN);

	// web assembly functions
	private weasModule: WascInterface = null;

	/**
	* delay audio initialization until page ready
	*/
	constructor() {
		super();
		waitReady().then(() => this.realInit());
	}

	/**
	* initializes audio processing pipeline
	* and starts listening on audio data
	* @ignore
	*/
	private async realInit() {
		// if wallpaper engine context given, listen
		if (!window['wallpaperRegisterAudioListener']) {
			Smallog.info('\'window.wallpaperRegisterAudioListener\' not given!');
			return;
		}

		this.weasModule = await wascWorker('WEAS.wasm', {}, !this.settings.low_latency);
		const {run} = this.weasModule;

		// pass settings to module
		await this.updateSettings();

		const self = this;

		// register audio callback on module
		window['wallpaperRegisterAudioListener']((audioArray) => {
			// Smallog.debug('Get Audio Data!');
			// check basic
			if (!self.settings.audioprocessing || audioArray == null || audioArray.length != DAT_LEN) {
				Smallog.error('audioListener: received invalid audio data array: ' + JSON.stringify([audioArray.length || null, audioArray]));
				return;
			}
			// check nulls
			let consecutiveNull = 0;
			for (let i = 0; i &lt; 15; i++) {
				const aA = audioArray[Math.floor(Math.random() * audioArray.length)];
				if (aA == 0.0) consecutiveNull++;
				else consecutiveNull = 0;
				if (consecutiveNull > 10) {
					Smallog.debug('Skipping received Null data!: ' + JSON.stringify(audioArray));
					return;
				}
			}

			// prepare data
			const start = performance.now();
			self.inBuff.set(audioArray);

			// WRAP IN isolated Function ran inside worker
			run(({module, instance, exports, params}) => {
				const ex = instance.exports as any;
				const {data} = params[0];

				// set audio data directly in module memory
				exports.__getFloat64ArrayView(ex.inputData).set(data);
				// trigger processing processing
				ex.update();
				// get copy of updated Data &amp; Properties
				const r = { // => result
					data: new Float64Array(exports.__getFloat64ArrayView(ex.outputData)),
					props: new Float64Array(exports.__getFloat64ArrayView(ex.audioProps)),
				};
				return r;
			}, // params passed to worker
			{
				data: self.inBuff,
			})
			// worker result, back in main context
				.then((result) => {
					const {data, props} = result;
					const realProps = self.getProps(props);
					// apply actual last Data from worker
					self.lastAudio = {
						time: start / 1000,
						data,
						...realProps,
					};
					// print info
					Smallog.debug('Got Data from Worker! Time= ' + (performance.now() - start) + ', Data= ' + JSON.stringify(realProps));
				});
		});
	}

	/**
	* converts calculated output property number-array to string-associative-array
	* @param {ArrayLike&lt;number>} dProps processed properties
	* @return {Object}
	* @ignore
	*/
	private getProps(dProps: ArrayLike&lt;number>) {
		const keys = Object.keys(PropIDs);
		const res = {};
		for (let index = 0; index &lt; keys.length; index++) {
			const key = keys[index];
			res[key] = dProps[PropIDs[key]];
		}
		return res;
	}

	/**
	* !! CAVEAT: only available after init and module load !!
	* &lt;br/>
	* Will send the processing settings to the WebAssembly module
	* @return {Promise} finished event
	*/
	public updateSettings(): Promise&lt;void> {
		if (!this.weasModule) return;
		const {run} = this.weasModule;

		return new Promise((resolve) => {
			const keys = Object.keys(SettIDs);
			const sett = new Float64Array(keys.length);
			for (let index = 0; index &lt; keys.length; index++) {
				const key = keys[index];
				sett[SettIDs[key]] = this.settings[key] || 0;
			}

			// isolated Function running inside worker
			run(({module, instance, exports, params}) => {
				const ex = instance.exports as any;
				const {data} = params[0];
				exports.__getFloat64ArrayView(ex.audioSettings).set(data);
			},
			// Data passed to worker
			{
				data: sett,
			})
			// Back to main context
				.then(() => {
					Smallog.info('Sent Settings to WEAS: ' + JSON.stringify(sett));
					resolve();
				});
		});
	}

	/**
	* @return {boolean} false if:
	* &lt;br/>
	* - processing is disabled
	* &lt;br/>
	* - there is no data
	* &lt;br/>
	* - the data is silent
	* &lt;br/>
	* - data is too old (> 3s)
	*/
	public hasAudio() {
		return this.settings.audioprocessing &amp;&amp;
		this.lastAudio &amp;&amp; this.lastAudio.silent == 0 &amp;&amp;
		(performance.now() / 1000 - this.lastAudio.time &lt; 3);
	}
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

</body>
</html>
