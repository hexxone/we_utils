

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> three/pass/UnrealBloomPass.ts</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    API Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="BlendShader.html">BlendShader</a></li><li><a href="BlurShader.html">BlurShader</a></li><li><a href="CComponent.html">CComponent</a></li><li><a href="ChromaticShader.html">ChromaticShader</a></li><li><a href="CopyShader.html">CopyShader</a></li><li><a href="CSettings.html">CSettings</a></li><li><a href="CUESettings.html">CUESettings</a></li><li><a href="EffectComposer.html">EffectComposer</a></li><li><a href="FPSettings.html">FPSettings</a></li><li><a href="FPStats.html">FPStats</a></li><li><a href="FractalMirrorShader.html">FractalMirrorShader</a></li><li><a href="FullScreenHelper.html">FullScreenHelper</a></li><li><a href="FXAAShader.html">FXAAShader</a></li><li><a href="LuminosityHighPassShader.html">LuminosityHighPassShader</a></li><li><a href="LUTShader.html">LUTShader</a></li><li><a href="LUTShaderNearest.html">LUTShaderNearest</a></li><li><a href="OfflinePlugin.html">OfflinePlugin</a></li><li><a href="ReloadHelper.html">ReloadHelper</a></li><li><a href="ReloadSettings.html">ReloadSettings</a></li><li><a href="RenderPass.html">RenderPass</a></li><li><a href="ShaderPass.html">ShaderPass</a></li><li><a href="UnrealBloomPass.html">UnrealBloomPass</a></li><li><a href="WarnHelper.html">WarnHelper</a></li><li><a href="WarnSettings.html">WarnSettings</a></li><li><a href="WEAS.html">WEAS</a></li><li><a href="WEASettings.html">WEASettings</a></li><li><a href="WEICUE.html">WEICUE</a></li><li><a href="WEWWA.html">WEWWA</a></li><li><a href="XRHelper.html">XRHelper</a></li><li><a href="XRSettings.html">XRSettings</a></li></ul><h3>Interfaces</h3><ul><li><a href="BasePass.html">BasePass</a></li><li><a href="BaseShader.html">BaseShader</a></li><li><a href="WEAudio.html">WEAudio</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getAllFiles">getAllFiles</a></li><li><a href="global.html#LogLevel">LogLevel</a></li><li><a href="global.html#LogLevel%255Bundefined%255D">LogLevel[undefined]</a></li><li><a href="global.html#offlineSchema">offlineSchema</a></li><li><a href="global.html#PropIDs">PropIDs</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#SettIDs">SettIDs</a></li><li><a href="global.html#Smallog">Smallog</a></li><li><a href="global.html#waitReady">waitReady</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>three/pass/UnrealBloomPass.ts</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* @author spidersharma / http://eduperiment.com/
*/

import {AdditiveBlending, Color, LinearFilter, MeshBasicMaterial, RGBAFormat, ShaderMaterial, UniformsUtils, Vector2, Vector3, WebGLRenderer, WebGLRenderTarget} from 'three';
import {FullScreenHelper} from './FullScreenHelper';
import {BasePass} from './BasePass';

import {CopyShader} from '../shader/CopyShader';
import {LuminosityHighPassShader} from '../shader/LuminosityHighPassShader';

/**
* Inspired from Unreal Engine
* https://docs.unrealengine.com/latest/INT/Engine/Rendering/PostProcessEffects/Bloom/
*
* @public
*/
export class UnrealBloomPass implements BasePass {
	name = 'UnrealBloom';
	strength = null;
	radius = null;
	resolution = null;
	threshold = null;
	renderTargetBright = null;
	highPassUniforms = null;

	// create color only once here, reuse it later inside the render function
	clear = true;
	clearColor = new Color(0, 0, 0);
	renderTargetsHorizontal: WebGLRenderTarget[] = [];
	renderTargetsVertical: WebGLRenderTarget[] = [];
	nMips = 5;

	separableBlurMaterials: ShaderMaterial[] = [];
	materialHighPassFilter: ShaderMaterial = null;
	compositeMaterial: ShaderMaterial = null;
	materialCopy: ShaderMaterial = null;
	bloomTintColors = null;
	copyUniforms = null;
	enabled = true;
	needsSwap = false;

	oldClearColor = new Color();
	oldClearAlpha = 1;

	basic = new MeshBasicMaterial();
	fsQuad = new FullScreenHelper(null);

	BlurDirectionX = new Vector2(1.0, 0.0);
	BlurDirectionY = new Vector2(0.0, 1.0);

	/**
	* Construct bloom shader
	* @param {Vector2} resolution size
	* @param {number} strength multiplier
	* @param {number} radius size
	* @param {number} threshold min val
	*/
	constructor(resolution: Vector2, strength: number, radius: number, threshold: number) {
		this.resolution = (resolution) ? resolution : new Vector2(256, 256);
		this.strength = (strength !== undefined) ? strength : 1;
		this.radius = radius;
		this.threshold = threshold;


		// render targets
		const pars = {minFilter: LinearFilter, magFilter: LinearFilter, format: RGBAFormat};
		let resx = Math.round(this.resolution.x / 2);
		let resy = Math.round(this.resolution.y / 2);

		this.renderTargetBright = new WebGLRenderTarget(resx, resy, pars);
		this.renderTargetBright.texture.name = 'UnrealBloomPass.bright';
		this.renderTargetBright.texture.generateMipmaps = false;

		for (let i = 0; i &lt; this.nMips; i++) {
			const renderTargetHorizonal = new WebGLRenderTarget(resx, resy, pars);
			renderTargetHorizonal.texture.name = 'UnrealBloomPass.h' + i;
			renderTargetHorizonal.texture.generateMipmaps = false;
			this.renderTargetsHorizontal.push(renderTargetHorizonal);

			const renderTargetVertical = new WebGLRenderTarget(resx, resy, pars);
			renderTargetVertical.texture.name = 'UnrealBloomPass.v' + i;
			renderTargetVertical.texture.generateMipmaps = false;
			this.renderTargetsVertical.push(renderTargetVertical);

			resx = Math.round(resx / 2);
			resy = Math.round(resy / 2);
		}

		// luminosity high pass material

		const highPassShader = new LuminosityHighPassShader();
		this.highPassUniforms = UniformsUtils.clone(highPassShader.uniforms);
		this.highPassUniforms['luminosityThreshold'].value = threshold;
		this.highPassUniforms['smoothWidth'].value = 0.01;

		this.materialHighPassFilter = new ShaderMaterial({
			uniforms: this.highPassUniforms,
			vertexShader: highPassShader.vertexShader,
			fragmentShader: highPassShader.fragmentShader,
			defines: {},
		});

		// Gaussian Blur Materials
		const kernelSizeArray = [3, 5, 7, 9, 11];
		resx = Math.round(this.resolution.x / 2);
		resy = Math.round(this.resolution.y / 2);

		for (let i = 0; i &lt; this.nMips; i++) {
			this.separableBlurMaterials.push(this.getSeperableBlurMaterial(kernelSizeArray[i]));
			this.separableBlurMaterials[i].uniforms['texSize'].value = new Vector2(resx, resy);

			resx = Math.round(resx / 2);
			resy = Math.round(resy / 2);
		}

		// Composite material
		this.compositeMaterial = this.getCompositeMaterial(this.nMips);
		this.compositeMaterial.uniforms['blurTexture1'].value = this.renderTargetsVertical[0].texture;
		this.compositeMaterial.uniforms['blurTexture2'].value = this.renderTargetsVertical[1].texture;
		this.compositeMaterial.uniforms['blurTexture3'].value = this.renderTargetsVertical[2].texture;
		this.compositeMaterial.uniforms['blurTexture4'].value = this.renderTargetsVertical[3].texture;
		this.compositeMaterial.uniforms['blurTexture5'].value = this.renderTargetsVertical[4].texture;
		this.compositeMaterial.uniforms['bloomStrength'].value = strength;
		this.compositeMaterial.uniforms['bloomRadius'].value = 0.1;
		this.compositeMaterial.needsUpdate = true;

		const bloomFactors = [1.0, 0.8, 0.6, 0.4, 0.2];
		this.compositeMaterial.uniforms['bloomFactors'].value = bloomFactors;
		this.bloomTintColors = [new Vector3(1, 1, 1), new Vector3(1, 1, 1), new Vector3(1, 1, 1), new Vector3(1, 1, 1), new Vector3(1, 1, 1)];
		this.compositeMaterial.uniforms['bloomTintColors'].value = this.bloomTintColors;

		// copy material

		const copyShader = new CopyShader();

		this.copyUniforms = UniformsUtils.clone(copyShader.uniforms);
		this.copyUniforms['opacity'].value = 1.0;

		this.materialCopy = new ShaderMaterial({
			uniforms: this.copyUniforms,
			vertexShader: copyShader.vertexShader,
			fragmentShader: copyShader.fragmentShader,
			blending: AdditiveBlending,
			depthTest: false,
			depthWrite: false,
			transparent: true,
		});
	}

	/**
	* Destroy shader
	*/
	public dispose() {
		for (let i = 0; i &lt; this.renderTargetsHorizontal.length; i++) {
			this.renderTargetsHorizontal[i].dispose();
		}
		for (let i = 0; i &lt; this.renderTargetsVertical.length; i++) {
			this.renderTargetsVertical[i].dispose();
		}
		this.renderTargetBright.dispose();
		this.fsQuad.dispose();
	}

	/**
	* Updated screen size
	* @param {number} width X
	* @param {number} height Y
	*/
	public setSize(width: number, height: number) {
		let resx = Math.round(width / 2);
		let resy = Math.round(height / 2);
		this.renderTargetBright.setSize(resx, resy);

		for (let i = 0; i &lt; this.nMips; i++) {
			this.renderTargetsHorizontal[i].setSize(resx, resy);
			this.renderTargetsVertical[i].setSize(resx, resy);

			this.separableBlurMaterials[i].uniforms['texSize'].value = new Vector2(resx, resy);

			resx = Math.round(resx / 2);
			resy = Math.round(resy / 2);
		}
	}

	/**
	* Render Frame
	* @param {WebGLRenderer} renderer Context
	* @param {WebGLRenderTarget} writeBuffer Output
	* @param {WebGLRenderTarget} readBuffer Input
	* @param {boolean} maskActive filter
	* @param {boolean} renderToScreen render to canvas OR buffer
	* @public
	*/
	public render(renderer: WebGLRenderer, writeBuffer: WebGLRenderTarget, readBuffer: WebGLRenderTarget, maskActive: boolean, renderToScreen: boolean) {
		renderer.getClearColor(this.oldClearColor);
		this.oldClearAlpha = renderer.getClearAlpha();
		const oldAutoClear = renderer.autoClear;
		renderer.autoClear = false;

		renderer.setClearColor(this.clearColor, 0);

		if (maskActive) renderer.context.disable(renderer.context.STENCIL_TEST);

		// Render input to screen
		if (renderToScreen) {
			this.fsQuad.setMaterial(this.basic);
			this.basic.map = readBuffer.texture;
			renderer.setRenderTarget(null);
			renderer.clear();
			this.fsQuad.render(renderer);
		}

		// 1. Extract Bright Areas

		this.highPassUniforms['tDiffuse'].value = readBuffer.texture;
		this.highPassUniforms['luminosityThreshold'].value = this.threshold;
		this.fsQuad.setMaterial(this.materialHighPassFilter);

		renderer.setRenderTarget(this.renderTargetBright);
		renderer.clear();
		this.fsQuad.render(renderer);

		// 2. Blur All the mips progressively

		let inputRenderTarget = this.renderTargetBright;

		for (let i = 0; i &lt; this.nMips; i++) {
			this.fsQuad.setMaterial(this.separableBlurMaterials[i]);

			this.separableBlurMaterials[i].uniforms['colorTexture'].value = inputRenderTarget.texture;
			this.separableBlurMaterials[i].uniforms['direction'].value = this.BlurDirectionX;
			renderer.setRenderTarget(this.renderTargetsHorizontal[i]);
			renderer.clear();
			this.fsQuad.render(renderer);

			this.separableBlurMaterials[i].uniforms['colorTexture'].value = this.renderTargetsHorizontal[i].texture;
			this.separableBlurMaterials[i].uniforms['direction'].value = this.BlurDirectionY;
			renderer.setRenderTarget(this.renderTargetsVertical[i]);
			renderer.clear();
			this.fsQuad.render(renderer);

			inputRenderTarget = this.renderTargetsVertical[i];
		}

		// Composite All the mips

		this.fsQuad.setMaterial(this.compositeMaterial);
		this.compositeMaterial.uniforms['bloomStrength'].value = this.strength;
		this.compositeMaterial.uniforms['bloomRadius'].value = this.radius;
		this.compositeMaterial.uniforms['bloomTintColors'].value = this.bloomTintColors;

		renderer.setRenderTarget(this.renderTargetsHorizontal[0]);
		renderer.clear();
		this.fsQuad.render(renderer);

		// Blend it additively over the input texture

		this.fsQuad.setMaterial(this.materialCopy);
		this.copyUniforms['tDiffuse'].value = this.renderTargetsHorizontal[0].texture;

		if (maskActive) renderer.context.enable(renderer.context.STENCIL_TEST);

		renderer.setRenderTarget(renderToScreen ? null : readBuffer);
		this.fsQuad.render(renderer);

		// Restore renderer settings
		renderer.setClearColor(this.oldClearColor, this.oldClearAlpha);
		renderer.autoClear = oldAutoClear;
	}

	/**
	* Make seperable material
	* @param {number} kernelRadius size
	* @return {ShaderMaterial}
	*/
	private getSeperableBlurMaterial(kernelRadius) {
		return new ShaderMaterial({

			defines: {
				'KERNEL_RADIUS': kernelRadius,
				'SIGMA': kernelRadius,
			},

			uniforms: {
				'colorTexture': {value: null},
				'texSize': {value: new Vector2(0.5, 0.5)},
				'direction': {value: new Vector2(0.5, 0.5)},
			},

			vertexShader: `
			varying vec2 vUv;
			void main() {
				vUv = uv;
				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			}`,

			fragmentShader:
			`#include &lt;common>
			
			varying vec2 vUv;
			uniform sampler2D colorTexture;
			uniform vec2 texSize;
			uniform vec2 direction;
			
			float gaussianPdf(in float x, in float sigma) {
				return 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;
			}
			void main() {
				vec2 invSize = 1.0 / texSize;
				float fSigma = float(SIGMA);
				float weightSum = gaussianPdf(0.0, fSigma);
				float alphaSum = 0.0;
				vec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;
				for( int i = 1; i &lt; KERNEL_RADIUS; i ++ ) {
					float x = float(i);
					float w = gaussianPdf(x, fSigma);
					vec2 uvOffset = direction * invSize * x;
					vec4 sample1 = texture2D( colorTexture, vUv + uvOffset);
					vec4 sample2 = texture2D( colorTexture, vUv - uvOffset);
					diffuseSum += (sample1.rgb + sample2.rgb) * w;
					alphaSum += (sample1.a + sample2.a) * w;
					weightSum += 2.0 * w;
				}
				gl_FragColor = vec4(diffuseSum/weightSum, alphaSum/weightSum);
			}`,
		});
	}

	/**
	* Make helper material
	* @param {number} nMips MipMaps
	* @return {ShaderMaterial}
	*/
	private getCompositeMaterial(nMips) {
		return new ShaderMaterial({

			defines: {
				'NUM_MIPS': nMips,
			},

			uniforms: {
				'blurTexture1': {value: null},
				'blurTexture2': {value: null},
				'blurTexture3': {value: null},
				'blurTexture4': {value: null},
				'blurTexture5': {value: null},
				'dirtTexture': {value: null},
				'bloomStrength': {value: 1.0},
				'bloomFactors': {value: null},
				'bloomTintColors': {value: null},
				'bloomRadius': {value: 0.0},
			},

			vertexShader: `
			varying vec2 vUv;
			void main() {
				vUv = uv;
				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			}`,

			fragmentShader: `
			varying vec2 vUv;
			
			uniform sampler2D blurTexture1;
			uniform sampler2D blurTexture2;
			uniform sampler2D blurTexture3;
			uniform sampler2D blurTexture4;
			uniform sampler2D blurTexture5;
			uniform sampler2D dirtTexture;
			uniform float bloomStrength;
			uniform float bloomRadius;
			uniform float bloomFactors[NUM_MIPS];
			uniform vec3 bloomTintColors[NUM_MIPS];
			
			float lerpBloomFactor(const in float factor) {
				float mirrorFactor = 1.2 - factor;
				return mix(factor, mirrorFactor, bloomRadius);
			}
			
			void main() {
				gl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) + 
				lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) + 
				lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) + 
				lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) + 
				lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );
			}`,
		});
	}
}
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by 
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>

</body>
</html>
